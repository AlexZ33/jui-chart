<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="charset=utf-8;"/>
    <script src="../lib/core.js"></script>
    <script src="../dist/chart.js"></script>
    <script src="resource/data/frame_data.js"></script>
</head>
<body >

<div id="chart"></div>

<script id="script_code">
    var result = [];
    var _ = jui.include("util.base");

    frameData.push({
        depth: 0,
        key: 0,
        parentKey: -1,
        sampleCount: 0,
        stackTraceHash: -1
    });

    var qs = _.sort(frameData);
    qs.setCompare(function(a, b) {
        return (a.depth < b.depth) ? true : false;
    });
    qs.run();

    var cache = {};
    for(var i = 0; i < frameData.length; i++) {
        var key = frameData[i].key;

        if(!cache[key]) {
            cache[key] = {
                data: frameData[i],
                children: []
            }
        }
    }
    for(var i = 1; i < frameData.length; i++) {
        var d = frameData[i],
            p = cache[d.parentKey];

        p.children.push(cache[d.key]);
    }

    var root = cache[0];
    for(var j = 0; j < root.children.length; j++) {
        root.data.sampleCount += root.children[j].data.sampleCount;
    }

    function createNodeData(node, index) {
        result.push({
            index: index,
            value: node.data.sampleCount,
            text: node.data.stackTraceHash
        });

        for(var i = 0; i < node.children.length; i++) {
            var cNode = node.children[i];
            createNodeData(cNode, index + "." + i);
        }
    }

    createNodeData(root, "0");

    jui.ready([ "chart.builder" ], function(chart) {

        c = chart("#chart", {
            width: 800,
            height : 2500,
            padding : 50,
            axis : [{
                data : result
            }],
            brush : [{
                type : "flame",
                target : [ "text" ],
                nodeOrient : "bottom",
                nodeAlign: "end",
                /*/
                nodeColor : function(node) {
                    return 1;
                },
                /**/
                textAlign : "start",
                format : function(node) {
                    if(node.width < 100) {
                        return "";
                    }

                    return node.text;
                },
                //activeNode : "0.1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.1.0.0.0.0.0.0.0"
                activeNode : 10,
                activeEvent : "click",
                autoColor: true
            }],
            widget : [{
                type : "tooltip",
                format : function(data) {
                    return data.text + " (" + data.value + ")";
                }
            }],
            event : {
                click: function(d, e) {
                    console.log(d);
                }
            }
        });
	})
</script>


</body>
</html>